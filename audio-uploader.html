<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio/Video Content Uploader</title>
    <meta name="description" content="Queue and process audio from video URLs (YouTube, Vimeo, etc.) and upload to Airtable">
    <meta name="category" content="Data">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #183263;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .config-section {
            background: #f8f9fa;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .config-group {
            display: flex;
            flex-direction: column;
        }

        .config-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .config-group input {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: monospace;
        }

        .config-group input:focus {
            outline: none;
            border-color: #183263;
        }

        .config-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .config-status.valid {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #9ae6b4;
        }

        .config-status.invalid {
            background: #fff5f5;
            color: #e53e3e;
            border: 1px solid #feb2b2;
        }

        .form-section {
            background: rgba(24, 50, 99, 0.05);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .form-section h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #183263;
        }

        .form-group input::placeholder, .form-group textarea::placeholder {
            color: #a0aec0;
        }

        .form-group small {
            color: #718096;
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
        }

        .timestamp-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #183263;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(24, 50, 99, 0.4);
        }

        .submit-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #183263;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .job-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .job-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .job-header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .job-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .job-icon {
            width: 40px;
            height: 40px;
            background: #183263;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .job-details h4 {
            font-size: 1rem;
            color: #2d3748;
            margin-bottom: 4px;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .job-details p {
            font-size: 0.85rem;
            color: #718096;
        }

        .job-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-queued {
            background: #fef5e7;
            color: #d69e2e;
        }

        .status-processing {
            background: #e6fffa;
            color: #319795;
        }

        .status-success {
            background: #f0fff4;
            color: #38a169;
        }

        .status-error {
            background: #fed7d7;
            color: #e53e3e;
        }

        .retry-btn {
            padding: 6px 12px;
            background: #183263;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s ease;
        }

        .retry-btn:hover {
            background: #2d4a7a;
        }

        .job-logs {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #e2e8f0;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .log-timestamp {
            color: #a0aec0;
            margin-right: 10px;
        }

        .log-level-info {
            color: #63b3ed;
        }

        .log-level-success {
            color: #68d391;
        }

        .log-level-error {
            color: #fc8181;
        }

        .log-level-warning {
            color: #f6e05e;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            color: #a0aec0;
        }

        .job-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .result-info {
            margin-top: 10px;
            padding: 10px;
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .result-url {
            word-break: break-all;
            color: #183263;
            font-family: monospace;
            font-size: 0.8rem;
        }

        .airtable-info {
            margin-top: 10px;
            padding: 10px;
            background: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #234e52;
        }

        .timeout-warning {
            margin-top: 15px;
            padding: 12px;
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #92400e;
        }

        .platform-info {
            margin-top: 10px;
            padding: 12px;
            background: #e6f3ff;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #1e40af;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .timestamp-group {
                grid-template-columns: 1fr;
            }

            .job-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .job-info {
                width: 100%;
            }

            .job-status {
                width: 100%;
                justify-content: space-between;
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .status-processing {
            animation: pulse 2s infinite;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Audio/Video Content Uploader</h1>
            <p>Queue processing audio from video URLs and upload to Airtable</p>
        </div>

        <div class="content">
            <div class="config-section">
                <h3>Configuration</h3>
                <div class="config-grid">
                    <div class="config-group">
                        <label for="apiKey">Airtable API Key</label>
                        <input type="password" id="apiKey" placeholder="pat...">
                    </div>
                    <div class="config-group">
                        <label for="specialNotes">Special Notes for Summary (optional)</label>
                        <textarea id="specialNotes" rows="2" placeholder="Notes to include in SpecialNotesSummary field"></textarea>
                    </div>
                </div>
                <div id="configStatus" class="config-status hidden"></div>
            </div>

            <div class="form-section">
                <h3>Add to Queue</h3>
                <form id="videoForm">
                    <div class="form-group">
                        <label for="title">Title*</label>
                        <input type="text" id="title" name="title" required
                               placeholder="Enter presentation or talk title">
                    </div>

                    <div class="form-group">
                        <label for="source_author">Author/Source*</label>
                        <input type="text" id="source_author" name="source_author" required
                               placeholder="Author name or source">
                    </div>

                    <div class="form-group">
                        <label for="content_url">Video/Audio URL*</label>
                        <input type="url" id="content_url" name="content_url" required
                               placeholder="https://vimeo.com/123456789, https://youtube.com/watch?v=abc123, or any other URL">
                        <small>Supports Vimeo, YouTube, direct media file links, and many other platforms</small>
                    </div>

                    <div class="form-group">
                        <label for="source_url">Source URL (optional)</label>
                        <input type="url" id="source_url" name="source_url"
                               placeholder="https://example.com/program or other source link">
                        <small>Link to conference program, speaker page, or other source</small>
                    </div>

                    <div class="timestamp-group">
                        <div class="form-group">
                            <label for="start_time">Start (optional)</label>
                            <input type="text" id="start_time" name="start_time"
                                   placeholder="00:01:03" pattern="^([0-9]{1,2}:)?[0-9]{1,2}:[0-9]{2}$">
                            <small>Format: MM:SS or HH:MM:SS. Requires FFmpeg for trimming.</small>
                        </div>

                        <div class="form-group">
                            <label for="end_time">End (optional)</label>
                            <input type="text" id="end_time" name="end_time"
                                   placeholder="00:15:16" pattern="^([0-9]{1,2}:)?[0-9]{1,2}:[0-9]{2}$">
                            <small>Format: MM:SS or HH:MM:SS. If empty, until end of file.</small>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn" disabled>
                        Add to Queue
                    </button>
                </form>

                <div class="platform-info">
                    <strong>Supported platforms:</strong> Vimeo, YouTube, direct MP4/MP3/WAV/M4A links, and many other video/audio platforms and formats.
                </div>

                <div class="timeout-warning">
                    <strong>Processing time:</strong> Large audio files may take 5-10 minutes or more to process.
                    If processing times out, the task will automatically retry.
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalJobs">0</div>
                    <div class="stat-label">Total Jobs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="queuedJobs">0</div>
                    <div class="stat-label">Queued</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="processingJobs">0</div>
                    <div class="stat-label">Processing</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="successJobs">0</div>
                    <div class="stat-label">Done</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="errorJobs">0</div>
                    <div class="stat-label">Errors</div>
                </div>
            </div>

            <div class="jobs-section">
                <div class="section-title">
                    <span>ðŸ“‹</span>
                    <span>Job Queue</span>
                </div>
                <div id="jobsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Storage keys
        const STORAGE_KEYS = {
            API_KEY: 'audio_uploader_airtable_api_key',
            SPECIAL_NOTES: 'audio_uploader_special_notes'
        };

        // Configuration
        const CONFIG = {
            CLOUD_FUNCTION_URL: 'https://functions.yandexcloud.net/d4e4902f1nkarshsn2sn',
            AIRTABLE_API_KEY: '',
            AIRTABLE_BASE_ID: 'appndBYladrJOkHXI',
            AIRTABLE_TABLE_ID: 'tblTgETSM0RB4swZD',
            SPECIAL_NOTES: '',
            MAX_RETRIES: 3,
            RETRY_DELAY: 3000,
            REQUEST_TIMEOUT: 600000
        };

        // Job statuses
        const JobStatus = {
            QUEUED: 'queued',
            PROCESSING: 'processing',
            SUCCESS: 'success',
            ERROR: 'error'
        };

        // Application state
        let jobQueue = [];
        let currentlyProcessing = false;

        // DOM elements
        const form = document.getElementById('videoForm');
        const submitBtn = document.getElementById('submitBtn');
        const apiKeyInput = document.getElementById('apiKey');
        const specialNotesInput = document.getElementById('specialNotes');
        const configStatus = document.getElementById('configStatus');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            initializeForm();
            initializeConfigInputs();
            updateStats();
        });

        function loadConfig() {
            const savedApiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
            const savedSpecialNotes = localStorage.getItem(STORAGE_KEYS.SPECIAL_NOTES);

            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                CONFIG.AIRTABLE_API_KEY = savedApiKey;
            }
            if (savedSpecialNotes) {
                specialNotesInput.value = savedSpecialNotes;
                CONFIG.SPECIAL_NOTES = savedSpecialNotes;
            }

            validateConfig();
        }

        function initializeConfigInputs() {
            apiKeyInput.addEventListener('input', () => {
                CONFIG.AIRTABLE_API_KEY = apiKeyInput.value.trim();
                localStorage.setItem(STORAGE_KEYS.API_KEY, CONFIG.AIRTABLE_API_KEY);
                validateConfig();
            });

            specialNotesInput.addEventListener('input', () => {
                CONFIG.SPECIAL_NOTES = specialNotesInput.value.trim();
                localStorage.setItem(STORAGE_KEYS.SPECIAL_NOTES, CONFIG.SPECIAL_NOTES);
            });
        }

        function validateConfig() {
            const isValid = !!CONFIG.AIRTABLE_API_KEY;

            if (isValid) {
                configStatus.textContent = 'âœ“ API Key saved';
                configStatus.className = 'config-status valid';
                submitBtn.disabled = false;
            } else {
                configStatus.textContent = 'Please enter your Airtable API Key';
                configStatus.className = 'config-status invalid';
                submitBtn.disabled = true;
            }
            configStatus.classList.remove('hidden');

            return isValid;
        }

        function initializeForm() {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!validateConfig()) {
                    alert('Please configure Airtable settings first');
                    return;
                }

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                if (!data.title || !data.source_author || !data.content_url) {
                    alert('Please fill in all required fields');
                    return;
                }

                if (!isValidUrl(data.content_url)) {
                    alert('Please enter a valid video/audio URL');
                    return;
                }

                if (data.start_time && !validateTimestamp(data.start_time)) {
                    alert('Invalid start time format (use MM:SS or HH:MM:SS)');
                    return;
                }

                if (data.end_time && !validateTimestamp(data.end_time)) {
                    alert('Invalid end time format (use MM:SS or HH:MM:SS)');
                    return;
                }

                const processData = { ...data };
                processData.vimeo_url = data.content_url;
                delete processData.content_url;

                addJobToQueue(processData);
                form.reset();

                if (!currentlyProcessing) {
                    processQueue();
                }
            });
        }

        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }

        function detectPlatform(url) {
            if (url.includes('vimeo.com')) return 'Vimeo';
            if (url.includes('youtube.com') || url.includes('youtu.be')) return 'YouTube';
            if (url.includes('soundcloud.com')) return 'SoundCloud';
            if (url.match(/\.(mp4|mp3|wav|m4a|avi|mov|flv|webm)(\?|$)/i)) return 'Direct Link';
            return 'Other';
        }

        function addJobToQueue(data) {
            const jobId = generateId();
            const platform = detectPlatform(data.vimeo_url);
            const job = {
                id: jobId,
                data: data,
                platform: platform,
                status: JobStatus.QUEUED,
                logs: [],
                retryCount: 0,
                result: null,
                airtableRecordId: null,
                createdAt: new Date()
            };

            jobQueue.unshift(job);
            addLog(job, 'info', `Job added to queue: "${data.title}" (${data.source_author}) - ${platform}`);

            renderJobItem(job);
            updateStats();
        }

        async function processQueue() {
            if (currentlyProcessing) return;

            const nextJob = jobQueue.find(job => job.status === JobStatus.QUEUED);
            if (!nextJob) {
                currentlyProcessing = false;
                return;
            }

            currentlyProcessing = true;
            await processJob(nextJob);

            currentlyProcessing = false;
            setTimeout(() => processQueue(), 1000);
        }

        async function processJob(job) {
            try {
                updateJobStatus(job, JobStatus.PROCESSING);
                addLog(job, 'info', `Starting audio processing from platform: ${job.platform}`);
                addLog(job, 'warning', 'Processing may take several minutes for large files...');

                addLog(job, 'info', 'Sending request to cloud function...');

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.REQUEST_TIMEOUT);

                const response = await fetch(CONFIG.CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(job.data),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                addLog(job, 'info', `Cloud Function response: ${response.status} ${response.statusText}`);

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }

                if (!result.success) {
                    throw new Error(result.error || 'Unknown error from Cloud Function');
                }

                job.result = result;
                addLog(job, 'success', `Audio processed: ${result.filename}`);
                addLog(job, 'success', `URL: ${result.url}`);

                if (result.format) {
                    addLog(job, 'info', `Format: ${result.format.toUpperCase()}`);
                }
                if (result.conversion_applied) {
                    addLog(job, 'info', 'MP3 conversion: applied');
                }
                if (result.trimming_applied) {
                    addLog(job, 'info', 'Audio trimming: applied');
                }
                if (result.warning) {
                    addLog(job, 'warning', result.warning);
                }

                addLog(job, 'info', 'Creating Airtable record...');
                await createAirtableRecord(job);

                updateJobStatus(job, JobStatus.SUCCESS);
                addLog(job, 'success', 'Job completed successfully!');

            } catch (error) {
                let errorMessage = error.message;

                if (error.name === 'AbortError') {
                    errorMessage = 'Request timeout (10 minutes). File may be too large.';
                    addLog(job, 'error', 'Request aborted due to timeout');
                } else if (errorMessage === 'Failed to fetch') {
                    errorMessage = 'Network error or browser timeout.';
                    addLog(job, 'error', 'Network error or browser timeout');
                }

                addLog(job, 'error', `Processing error: ${errorMessage}`);

                if (job.retryCount < CONFIG.MAX_RETRIES) {
                    job.retryCount++;
                    addLog(job, 'warning', `Retry ${job.retryCount}/${CONFIG.MAX_RETRIES} in ${CONFIG.RETRY_DELAY/1000} sec...`);

                    setTimeout(() => {
                        updateJobStatus(job, JobStatus.QUEUED);
                        addLog(job, 'info', 'Returned to queue for retry');
                    }, CONFIG.RETRY_DELAY);
                } else {
                    updateJobStatus(job, JobStatus.ERROR);
                    addLog(job, 'error', 'Max retries exceeded');
                }
            }
        }

        async function createAirtableRecord(job) {
            const maxRetries = 3;
            let lastError = null;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    addLog(job, 'info', `Creating Airtable record (attempt ${attempt}/${maxRetries})...`);

                    const specialNotes = CONFIG.SPECIAL_NOTES || `Source platform: ${job.platform}`;

                    const airtableData = {
                        records: [{
                            fields: {
                                OriginalTitle: job.data.title,
                                'Source/Author': job.data.source_author,
                                FileURL: job.result.url,
                                Status: 'Ready for Transcription',
                                Language: 'en',
                                SpecialNotesSummary: specialNotes
                            }
                        }]
                    };

                    if (job.data.source_url && job.data.source_url.trim()) {
                        airtableData.records[0].fields.SourceURL = job.data.source_url.trim();
                    }

                    const airtableController = new AbortController();
                    const airtableTimeoutId = setTimeout(() => airtableController.abort(), 30000);

                    const airtableResponse = await fetch(
                        `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${CONFIG.AIRTABLE_TABLE_ID}`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(airtableData),
                            signal: airtableController.signal
                        }
                    );

                    clearTimeout(airtableTimeoutId);
                    addLog(job, 'info', `Airtable API response: ${airtableResponse.status} ${airtableResponse.statusText}`);

                    if (!airtableResponse.ok) {
                        const errorData = await airtableResponse.text();
                        throw new Error(`Airtable API error ${airtableResponse.status}: ${errorData}`);
                    }

                    const airtableResult = await airtableResponse.json();
                    job.airtableRecordId = airtableResult.records[0].id;

                    addLog(job, 'success', `Airtable record created: ${job.airtableRecordId}`);
                    addLog(job, 'info', `Source platform: ${job.platform}`);

                    if (job.data.source_url && job.data.source_url.trim()) {
                        addLog(job, 'info', `SourceURL saved: ${job.data.source_url}`);
                    }

                    return;

                } catch (error) {
                    lastError = error;
                    let errorMessage = error.message;

                    if (error.name === 'AbortError') {
                        errorMessage = 'Airtable request timeout (30 sec)';
                    } else if (errorMessage === 'Failed to fetch') {
                        errorMessage = 'Network error connecting to Airtable API';
                    }

                    addLog(job, 'warning', `Attempt ${attempt} failed: ${errorMessage}`);

                    if (attempt < maxRetries) {
                        const delay = attempt * 2000;
                        addLog(job, 'info', `Waiting ${delay/1000} sec before retry...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            addLog(job, 'error', `Failed to create Airtable record after ${maxRetries} attempts`);
            addLog(job, 'error', `Last error: ${lastError?.message || 'Unknown error'}`);
            addLog(job, 'warning', 'Audio processed successfully, but Airtable record was not created');
        }

        function renderJobItem(job) {
            const jobsList = document.getElementById('jobsList');

            const jobDiv = document.createElement('div');
            jobDiv.className = 'job-item fade-in';
            jobDiv.id = `job-${job.id}`;

            const trimInfo = (job.data.start_time || job.data.end_time) ?
                ` â€¢ Trim: ${job.data.start_time || '00:00'} - ${job.data.end_time || 'end'}` : '';

            const sourceInfo = job.data.source_url ? ` â€¢ Source provided` : '';

            jobDiv.innerHTML = `
                <div class="job-header" onclick="toggleLogs('${job.id}')">
                    <div class="job-info">
                        <div class="job-icon">ðŸŽµ</div>
                        <div class="job-details">
                            <h4>${job.data.title}</h4>
                            <p>${job.data.source_author} â€¢ ${job.platform} â€¢ Added ${job.createdAt.toLocaleTimeString()}${trimInfo}${sourceInfo}</p>
                        </div>
                    </div>
                    <div class="job-status">
                        <span class="status-badge status-${job.status}" id="status-${job.id}">
                            ${getStatusText(job.status)}
                        </span>
                        <button class="retry-btn hidden" id="retry-${job.id}" onclick="retryJob('${job.id}')">
                            ðŸ”„ Retry
                        </button>
                        <span class="expand-icon">â–¼</span>
                    </div>
                </div>
                <div class="job-logs hidden" id="logs-${job.id}"></div>
            `;

            jobsList.insertBefore(jobDiv, jobsList.firstChild);
            updateJobDisplay(job);
        }

        function updateJobStatus(job, status) {
            job.status = status;
            updateJobDisplay(job);
            updateStats();
        }

        function updateJobDisplay(job) {
            const statusElement = document.getElementById(`status-${job.id}`);
            const retryBtn = document.getElementById(`retry-${job.id}`);
            const logsContainer = document.getElementById(`logs-${job.id}`);

            if (statusElement) {
                statusElement.className = `status-badge status-${job.status}`;
                statusElement.textContent = getStatusText(job.status);
            }

            if (retryBtn) {
                if (job.status === JobStatus.ERROR) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }
            }

            if (job.status === JobStatus.SUCCESS && job.result && logsContainer) {
                let existingResult = logsContainer.querySelector('.result-info');
                if (!existingResult) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'result-info';
                    resultDiv.innerHTML = `
                        <strong>Result:</strong><br>
                        <strong>File:</strong> ${job.result.filename}<br>
                        <strong>URL:</strong> <span class="result-url">${job.result.url}</span><br>
                        <strong>Size:</strong> ${formatFileSize(job.result.file_size)}<br>
                        <strong>Format:</strong> ${job.result.format?.toUpperCase() || 'N/A'}<br>
                        <strong>Platform:</strong> ${job.platform}
                    `;
                    logsContainer.appendChild(resultDiv);
                }

                if (job.airtableRecordId) {
                    let existingAirtable = logsContainer.querySelector('.airtable-info');
                    if (!existingAirtable) {
                        const airtableDiv = document.createElement('div');
                        airtableDiv.className = 'airtable-info';
                        airtableDiv.innerHTML = `
                            <strong>Airtable:</strong> Record created<br>
                            <strong>Record ID:</strong> ${job.airtableRecordId}<br>
                            <strong>Status:</strong> Ready for Transcription
                        `;
                        logsContainer.appendChild(airtableDiv);
                    }
                }
            }
        }

        function addLog(job, level, message) {
            const timestamp = new Date().toLocaleTimeString();
            job.logs.push({
                timestamp,
                level,
                message
            });

            const logsContainer = document.getElementById(`logs-${job.id}`);
            if (logsContainer) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="log-level-${level}">[${level.toUpperCase()}]</span>
                    ${message}
                `;
                logsContainer.appendChild(logEntry);
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        function toggleLogs(jobId) {
            const jobItem = document.getElementById(`job-${jobId}`);
            const logsContainer = document.getElementById(`logs-${jobId}`);

            if (jobItem && logsContainer) {
                if (logsContainer.classList.contains('hidden')) {
                    logsContainer.classList.remove('hidden');
                    jobItem.classList.add('expanded');
                } else {
                    logsContainer.classList.add('hidden');
                    jobItem.classList.remove('expanded');
                }
            }
        }

        function retryJob(jobId) {
            const job = jobQueue.find(item => item.id === jobId);
            if (job) {
                job.retryCount = 0;
                updateJobStatus(job, JobStatus.QUEUED);
                addLog(job, 'info', 'Job returned to queue by user request');

                if (!currentlyProcessing) {
                    processQueue();
                }
            }
        }

        function updateStats() {
            const total = jobQueue.length;
            const queued = jobQueue.filter(job => job.status === JobStatus.QUEUED).length;
            const processing = jobQueue.filter(job => job.status === JobStatus.PROCESSING).length;
            const success = jobQueue.filter(job => job.status === JobStatus.SUCCESS).length;
            const error = jobQueue.filter(job => job.status === JobStatus.ERROR).length;

            document.getElementById('totalJobs').textContent = total;
            document.getElementById('queuedJobs').textContent = queued;
            document.getElementById('processingJobs').textContent = processing;
            document.getElementById('successJobs').textContent = success;
            document.getElementById('errorJobs').textContent = error;
        }

        function getStatusText(status) {
            const statusMap = {
                [JobStatus.QUEUED]: 'Queued',
                [JobStatus.PROCESSING]: 'Processing',
                [JobStatus.SUCCESS]: 'Done',
                [JobStatus.ERROR]: 'Error'
            };
            return statusMap[status] || status;
        }

        function validateTimestamp(timestamp) {
            const regex = /^([0-9]{1,2}:)?[0-9]{1,2}:[0-9]{2}$/;
            return regex.test(timestamp);
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        window.addEventListener('beforeunload', function(e) {
            const hasActiveJobs = jobQueue.some(job =>
                job.status === JobStatus.PROCESSING || job.status === JobStatus.QUEUED
            );

            if (hasActiveJobs) {
                e.preventDefault();
                e.returnValue = 'You have jobs in queue or processing. Are you sure you want to leave?';
            }
        });

        console.log('Audio/Video Content Uploader initialized');
    </script>
</body>
</html>
